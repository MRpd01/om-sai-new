// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums matching your Supabase types
enum UserRole {
  user
  admin
}

enum SubscriptionType {
  full_month
  half_month
  single_morning
  single_evening
  double_time
}

enum PaymentStatus {
  success
  due
  pending
  failed
}

enum EnquiryStatus {
  pending
  responded
  closed
}

enum RequestStatus {
  pending
  approved
  rejected
}

// Users table (extends Supabase auth.users)
model User {
  id                    String                  @id @db.Uuid
  name                  String
  mobile_number         String                  @unique
  parent_mobile         String?
  photo_url             String?
  role                  UserRole                @default(user)
  mess_id               String?                 @db.Uuid
  is_active             Boolean                 @default(true)
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @updatedAt @db.Timestamptz(6)

  // Relations
  mess                  Mess?                   @relation("UserMess", fields: [mess_id], references: [id], onDelete: SetNull)
  ownedMess             Mess?                   @relation("MessOwner")
  memberships           MessMember[]
  payments              Payment[]
  enquiries             Enquiry[]
  adminAssignments      MessAdmin[]             @relation("AdminUser")
  assignedAdmins        MessAdmin[]             @relation("AssignedBy")
  notifications         Notification[]
  subscriptionRequests  SubscriptionRequest[]
  processedRequests     SubscriptionRequest[]   @relation("ProcessedBy")

  @@map("users")
}

// Messes table
model Mess {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name                  String
  description           String?
  admin_id              String                  @db.Uuid
  pricing               Json                    @default("{\"full_month\": 0, \"half_month\": 0, \"single_morning\": 0, \"single_evening\": 0, \"double_time\": 0}")
  is_active             Boolean                 @default(true)
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @updatedAt @db.Timestamptz(6)

  // Relations
  admin                 User                    @relation("MessOwner", fields: [admin_id], references: [id], onDelete: Cascade)
  users                 User[]                  @relation("UserMess")
  members               MessMember[]
  payments              Payment[]
  enquiries             Enquiry[]
  admins                MessAdmin[]
  menus                 Menu[]
  subscriptionRequests  SubscriptionRequest[]

  @@map("messes")
}

// Mess Members table
model MessMember {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id               String                  @db.Uuid
  mess_id               String                  @db.Uuid
  subscription_type     SubscriptionType
  payment_status        PaymentStatus           @default(due)
  joining_date          DateTime                @default(now()) @db.Date
  expiry_date           DateTime                @db.Date
  is_active             Boolean                 @default(true)
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @updatedAt @db.Timestamptz(6)

  // Relations
  user                  User                    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  mess                  Mess                    @relation(fields: [mess_id], references: [id], onDelete: Cascade)

  @@unique([user_id, mess_id])
  @@map("mess_members")
}

// Payments table
model Payment {
  id                              String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                         String                  @db.Uuid
  mess_id                         String                  @db.Uuid
  amount                          Decimal                 @db.Decimal(10, 2)
  phonepe_transaction_id          String                  @unique
  phonepe_merchant_transaction_id String?                 @unique
  status                          PaymentStatus           @default(pending)
  subscription_type               SubscriptionType
  created_at                      DateTime                @default(now()) @db.Timestamptz(6)
  updated_at                      DateTime                @default(now()) @updatedAt @db.Timestamptz(6)

  // Relations
  user                            User                    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  mess                            Mess                    @relation(fields: [mess_id], references: [id], onDelete: Cascade)

  @@map("payments")
}

// Enquiries table
model Enquiry {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id               String                  @db.Uuid
  mess_id               String                  @db.Uuid
  message               String
  status                EnquiryStatus           @default(pending)
  admin_response        String?
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @updatedAt @db.Timestamptz(6)

  // Relations
  user                  User                    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  mess                  Mess                    @relation(fields: [mess_id], references: [id], onDelete: Cascade)

  @@map("enquiries")
}

// Mess Admins table
model MessAdmin {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mess_id               String                  @db.Uuid
  user_id               String                  @db.Uuid
  assigned_by           String                  @db.Uuid
  is_active             Boolean                 @default(true)
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @updatedAt @db.Timestamptz(6)

  // Relations
  mess                  Mess                    @relation(fields: [mess_id], references: [id], onDelete: Cascade)
  user                  User                    @relation("AdminUser", fields: [user_id], references: [id], onDelete: Cascade)
  assigner              User                    @relation("AssignedBy", fields: [assigned_by], references: [id])

  @@unique([mess_id, user_id])
  @@map("mess_admins")
}

// Notifications table
model Notification {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id               String                  @db.Uuid
  type                  String
  title                 String
  message               String
  is_read               Boolean                 @default(false)
  sent_via              Json                    @default("{\"email\": false, \"whatsapp\": false}")
  created_at            DateTime                @default(now()) @db.Timestamptz(6)

  // Relations
  user                  User                    @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("notifications")
}

// Menus table
model Menu {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  mess_id               String                  @db.Uuid
  menu_date             DateTime                @db.Date
  title                 String?
  notes                 String?
  is_active             Boolean                 @default(true)
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @updatedAt @db.Timestamptz(6)

  // Relations
  mess                  Mess                    @relation(fields: [mess_id], references: [id], onDelete: Cascade)
  items                 MenuItem[]

  @@unique([mess_id, menu_date])
  @@map("menus")
}

// Menu Items table
model MenuItem {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  menu_id               String                  @db.Uuid
  name                  String
  description           String?
  is_veg                Boolean                 @default(true)
  price                 Decimal                 @default(0) @db.Decimal(10, 2)
  image_url             String?
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @updatedAt @db.Timestamptz(6)

  // Relations
  menu                  Menu                    @relation(fields: [menu_id], references: [id], onDelete: Cascade)

  @@map("menu_items")
}

// Subscription Requests table
model SubscriptionRequest {
  id                    String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id               String                  @db.Uuid
  mess_id               String                  @db.Uuid
  user_name             String
  user_email            String
  user_phone            String?
  requested_plan        SubscriptionType
  requested_join_date   DateTime                @db.Date
  request_message       String?
  status                String                  @default("pending")
  admin_notes           String?
  created_at            DateTime                @default(now()) @db.Timestamptz(6)
  updated_at            DateTime                @default(now()) @updatedAt @db.Timestamptz(6)
  processed_by          String?                 @db.Uuid
  processed_at          DateTime?               @db.Timestamptz(6)

  // Relations
  user                  User                    @relation(fields: [user_id], references: [id], onDelete: Cascade)
  mess                  Mess                    @relation(fields: [mess_id], references: [id], onDelete: Cascade)
  processor             User?                   @relation("ProcessedBy", fields: [processed_by], references: [id])

  @@map("subscription_requests")
}

